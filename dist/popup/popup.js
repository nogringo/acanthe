(()=>{document.addEventListener("DOMContentLoaded",z);var E=document.getElementById("setup-screen"),k=document.getElementById("unlock-screen"),L=document.getElementById("main-screen"),I=document.getElementById("settings-screen"),B=document.getElementById("change-password-screen"),T=document.getElementById("setup-form"),M=document.getElementById("unlock-form"),$=document.getElementById("change-password-form"),U=document.getElementById("lock-btn"),A=document.getElementById("settings-btn"),F=document.getElementById("back-btn"),q=document.getElementById("back-from-password-btn"),H=document.getElementById("export-btn"),O=document.getElementById("change-password-btn"),j=document.getElementById("reset-btn"),l=document.getElementById("passkeys-list"),C=document.getElementById("search-input"),p=document.getElementById("clear-search"),y=document.getElementById("current-site-section"),b=document.getElementById("current-site-passkeys"),R=document.getElementById("current-site-name"),w=document.getElementById("setup-error"),S=document.getElementById("unlock-error"),u=document.getElementById("change-password-error"),N=document.getElementById("change-password-success"),d=[],m=null,P="main";async function z(){try{let[e]=await chrome.tabs.query({active:!0,currentWindow:!0});e?.url&&(m=new URL(e.url).hostname)}catch{console.log("Could not get current tab")}(await o("checkSetup")).isSetup?(await o("isUnlocked")).unlocked?(a("main"),h()):a("unlock"):a("setup"),J()}function a(t){switch(E.classList.add("hidden"),k.classList.add("hidden"),L.classList.add("hidden"),I.classList.add("hidden"),B.classList.add("hidden"),t){case"setup":E.classList.remove("hidden"),document.getElementById("setup-password").focus();break;case"unlock":k.classList.remove("hidden"),document.getElementById("unlock-password").focus();break;case"main":L.classList.remove("hidden");break;case"settings":I.classList.remove("hidden");break;case"change-password":B.classList.remove("hidden"),document.getElementById("current-password").focus();break}}function J(){T.addEventListener("submit",K),M.addEventListener("submit",Y),$.addEventListener("submit",Q),U.addEventListener("click",G),A.addEventListener("click",()=>{P="main",a("settings")}),F.addEventListener("click",()=>a(P)),q.addEventListener("click",()=>a("settings")),document.querySelectorAll(".toggle-password").forEach(e=>{e.addEventListener("click",V)}),document.getElementById("setup-password").addEventListener("input",W),C.addEventListener("input",ee),p.addEventListener("click",te),H.addEventListener("click",se),O.addEventListener("click",()=>a("change-password")),j.addEventListener("click",X)}function V(t){let e=t.currentTarget.dataset.target,n=document.getElementById(e),s=t.currentTarget;n.type==="password"?(n.type="text",s.textContent="\u{1F648}"):(n.type="password",s.textContent="\u{1F441}\uFE0F")}function W(t){let e=t.target.value,n=document.querySelector(".strength-fill"),s=document.querySelector(".strength-text");if(!e){n.className="strength-fill",s.textContent="Enter a password";return}let r=Z(e);r<2?(n.className="strength-fill weak",s.textContent="Weak"):r<4?(n.className="strength-fill medium",s.textContent="Medium"):(n.className="strength-fill strong",s.textContent="Strong")}function Z(t){let e=0;return t.length>=8&&e++,t.length>=12&&e++,/[a-z]/.test(t)&&/[A-Z]/.test(t)&&e++,/\d/.test(t)&&e++,/[^a-zA-Z0-9]/.test(t)&&e++,e}async function K(t){t.preventDefault();let e=document.getElementById("setup-password").value,n=document.getElementById("setup-confirm").value;if(e!==n){i(w,"Passwords do not match");return}if(e.length<8){i(w,"Password must be at least 8 characters");return}let s=await o("setupMasterPassword",{password:e});s.success?(a("main"),h()):i(w,s.error)}async function Y(t){t.preventDefault();let e=document.getElementById("unlock-password").value,n=await o("unlock",{password:e});n.success?(a("main"),h(),document.getElementById("unlock-password").value="",v(S)):i(S,n.error)}async function G(){await o("lock"),a("unlock")}async function Q(t){t.preventDefault(),v(u),v(N);let e=document.getElementById("current-password").value,n=document.getElementById("new-password").value,s=document.getElementById("confirm-new-password").value;if(n!==s){i(u,"New passwords do not match");return}if(n.length<8){i(u,"New password must be at least 8 characters");return}let r=await o("changePassword",{currentPassword:e,newPassword:n});r.success?(ne(N,"Password updated successfully"),document.getElementById("current-password").value="",document.getElementById("new-password").value="",document.getElementById("confirm-new-password").value=""):i(u,r.error||"Failed to change password")}async function X(){if(!confirm(`Are you sure you want to reset the extension?

This will permanently delete ALL your passkeys and cannot be undone.`)||!confirm(`This is your last chance to cancel.

Type OK to confirm you want to delete all passkeys.`))return;let n=await o("reset");n.success?a("setup"):alert("Failed to reset: "+(n.error||"Unknown error"))}async function h(){let t=await o("getPasskeys");if(!t.success){l.innerHTML='<div class="empty-state"><div class="empty-icon">\u26A0\uFE0F</div><h4>Error loading passkeys</h4></div>';return}d=t.passkeys,f(d),_()}function _(){if(!m){y.classList.add("hidden");return}let t=d.filter(e=>e.rpId===m);if(t.length===0){y.classList.add("hidden");return}y.classList.remove("hidden"),R.textContent=m,b.innerHTML=t.map(e=>x(e,!0)).join(""),b.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",D)})}function f(t){if(t.length===0){l.innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">\u{1F511}</div>
        <h4>No passkeys yet</h4>
        <p>Visit a website that supports passkeys to create one.</p>
      </div>
    `;return}let e={};t.forEach(r=>{let c=r.rpId;e[c]||(e[c]=[]),e[c].push(r)});let n=Object.keys(e).sort(),s="";n.forEach(r=>{s+='<div class="site-group">',s+=`<div class="site-group-header">${g(r)}</div>`,e[r].forEach(c=>{s+=x(c,!1)}),s+="</div>"}),l.innerHTML=s,l.querySelectorAll(".delete-btn").forEach(r=>{r.addEventListener("click",D)})}function x(t,e){let n=(t.userDisplayName||t.userName||"?")[0].toUpperCase();return`
    <div class="${e?"passkey-item current-site":"passkey-item"}" data-id="${t.credentialId}">
      <div class="passkey-avatar">${n}</div>
      <div class="passkey-info">
        <div class="passkey-site">${g(t.rpName||t.rpId)}</div>
        <div class="passkey-user">${g(t.userDisplayName||t.userName||"Unknown")}</div>
        <div class="passkey-meta">
          <span class="passkey-date">${re(t.createdAt)}</span>
        </div>
      </div>
      <div class="passkey-actions">
        <button class="btn btn-danger delete-btn" data-id="${t.credentialId}">Delete</button>
      </div>
    </div>
  `}function ee(t){let e=t.target.value.toLowerCase().trim();if(e){p.classList.remove("hidden");let n=d.filter(s=>s.rpId&&s.rpId.toLowerCase().includes(e)||s.rpName&&s.rpName.toLowerCase().includes(e)||s.userName&&s.userName.toLowerCase().includes(e)||s.userDisplayName&&s.userDisplayName.toLowerCase().includes(e));n.length===0?l.innerHTML=`
        <div class="no-results">
          <div class="no-results-icon">\u{1F50D}</div>
          <p>No passkeys found for "${g(e)}"</p>
        </div>
      `:f(n)}else p.classList.add("hidden"),f(d)}function te(){C.value="",p.classList.add("hidden"),f(d)}async function D(t){t.stopPropagation();let e=t.target.dataset.id;if(!confirm("Delete this passkey? This cannot be undone."))return;let n=await o("deletePasskey",{credentialId:e});n.success?h():alert("Failed to delete passkey: "+n.error)}async function se(){if(d.length===0){alert("No passkeys to export");return}let t=d.map(r=>({site:r.rpId,siteName:r.rpName,user:r.userName,displayName:r.userDisplayName,createdAt:r.createdAt})),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),s=document.createElement("a");s.href=n,s.download=`passkeys-export-${new Date().toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(n)}function o(t,e={}){return new Promise(n=>{chrome.runtime.sendMessage({action:t,data:e},s=>{n(s||{success:!1,error:"No response"})})})}function i(t,e){t.textContent=e,t.classList.remove("hidden")}function ne(t,e){t.textContent=e,t.classList.remove("hidden")}function v(t){t.classList.add("hidden")}function g(t){let e=document.createElement("div");return e.textContent=t||"",e.innerHTML}function re(t){if(!t)return"Unknown";let e=new Date(t),s=new Date-e;if(s<864e5){let r=Math.floor(s/36e5);if(r===0){let c=Math.floor(s/6e4);return c<=1?"Just now":`${c}m ago`}return`${r}h ago`}if(s<6048e5){let r=Math.floor(s/864e5);return r===1?"Yesterday":`${r} days ago`}return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}})();
